name: Apply Supabase RLS

on:
  workflow_dispatch: {}

jobs:
  apply-rls:
    runs-on: ubuntu-latest
    env:
      PSQL_CONN: ${{ secrets.PSQL_CONN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install psql
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Apply RLS SQL
        run: |
          if [ -z "$PSQL_CONN" ]; then
            echo "ERROR: PSQL_CONN secret is not set" >&2
            exit 1
          fi
          echo "Applying RLS SQL from repo: db/rls_policies.sql"
          psql "$PSQL_CONN" -f db/rls_policies.sql
          echo "Listing created policies for verification"
          psql "$PSQL_CONN" -c "SELECT policyname, schemaname, tablename FROM pg_policies WHERE tablename IN ('posts','comments');"
